# Многоязычная система для банковского бота (упрощенная)

## Обзор

Упрощенная многоязычная система, где LLM сам определяет язык пользователя и либо возвращает JSON с языком и текстом, либо добавляет параметр `language` в function calls.

## Поддерживаемые языки

- **ky** - Кыргызский (по умолчанию)
- **ru** - Русский  
- **en** - Английский

## Основные компоненты

### 1. Параметр language во всех функциях

Все функции принимают параметр `language`:

```python
# Примеры вызовов функций
get_balance(language="ru")  # Получить баланс на русском
get_transactions(limit=5, language="en")  # Транзакции на английском
transfer_money(to_name="John", amount=1000, language="ky")  # Перевод на кыргызском
```

### 2. Автоматическое определение языка LLM

LLM сам определяет язык пользователя и:
- Для function calls: добавляет параметр `language`
- Для текстовых ответов: возвращает JSON `{"language": "ru", "text": "ответ"}`

### 3. Перевод ответов

Все ответы переводятся с помощью `translate_format_text`:

```python
# Перевод текста
translated_text = await banking_chatbot.translate_format_text(text, target_language)
```

## Использование

### Базовое использование

```python
from gemini_service import banking_chatbot

# Обычный ответ (LLM сам определяет язык)
response = banking_chatbot.get_response("Мой баланс", user=user)

# Структурированный ответ
result = banking_chatbot.get_structured_response("My balance", user=user)
print(f"Language: {result['language']}")
print(f"Response: {result['text']}")
```

### Function Calling с параметром language

LLM автоматически добавляет параметр `language` к function calls:

```python
# LLM автоматически добавит language="ru" для русского запроса
result = banking_chatbot.handle_gemini_function_call(user, function_call)
```

## Архитектура

1. **LLM анализирует запрос**: Определяет язык пользователя
2. **Function Calling**: LLM добавляет параметр `language` к вызову функции
3. **Обработка**: Функция возвращает результат на кыргызском
4. **Перевод**: Если `language != 'ky'`, результат переводится через `translate_format_text`
5. **Возврат**: Пользователь получает ответ на своем языке

## Преимущества упрощенной системы

- **Простота**: Только один метод `translate_format_text` для перевода
- **Автоматичность**: LLM сам определяет язык и добавляет параметр
- **Гибкость**: Поддержка как function calling, так и JSON ответов
- **Совместимость**: Работает со всеми существующими функциями
- **Минимум кода**: Убраны лишние методы определения языка

## Обработка ошибок

Система включает обработку ошибок:
- Если перевод не удается, возвращается оригинальный текст
- Если JSON парсинг не удается, текст обрабатывается как обычный ответ
- Все ошибки логируются для отладки

## Тестирование

Запустите тесты для проверки многоязычности:

```bash
python3 test_new_multilingual.py
```

Тесты проверяют:
- Перевод текста
- Структурированные ответы
- Простые ответы

## Примеры работы

### Русский запрос
```
Пользователь: "Мой баланс"
LLM: get_balance(language="ru")
Результат: "Ваш баланс составляет 1000 сом"
```

### Английский запрос
```
Пользователь: "Show my transactions"
LLM: get_transactions(language="en")
Результат: "Your recent transactions: ..."
```

### Кыргызский запрос
```
Пользователь: "Менин балансым"
LLM: get_balance(language="ky")
Результат: "Сиздин балансыңыз 1000 сом"
```

### Текстовый ответ
```
Пользователь: "Привет"
LLM: {"language": "ru", "text": "Здравствуйте! Чем могу помочь?"}
Результат: "Здравствуйте! Чем могу помочь?"
``` 